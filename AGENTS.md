# AGENTS.md - iflow-go 开发规则与阶段指南

> **重要**: 本文档定义了项目的开发规则和阶段执行流程。所有开发工作必须遵循此文档。

---

## 1. 核心原则

### 1.1 文档优先
- **架构文档** (`docs/architecture.md`) 是项目的单一真实来源
- 如实施中发现架构文档与实际情况有冲突，**必须先更新文档再继续实施**
- 任何架构变更都必须记录在文档更新记录中

### 1.2 阶段顺序
- 必须严格按照 `docs/plan.md` 中定义的阶段顺序执行
- 每个阶段必须全部完成后才能进入下一阶段
- 禁止跳过阶段或并行执行多个阶段

### 1.3 计划归档
- 整个实施计划完成后，归档到 `docs/archive/` 目录
- 归档文件不可删除，作为项目历史记录
- 归档命名格式: `plan-completed-{YYYYMMDD}.md`

---

## 2. 阶段执行流程

```
┌─────────────────────────────────────────────────────────────┐
│                    开始新阶段                                │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 读取 docs/plan.md 中对应阶段的任务清单                   │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 检查 docs/architecture.md 是否需要更新                  │
│     - 如有冲突，先更新文档                                   │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 按任务清单顺序执行                                       │
│     - 每个任务完成后标记 [x]                                 │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 阶段验收                                                 │
│     - 运行 `go test ./...`                                  │
│     - 运行 `go vet ./...`                                   │
│     - 检查所有验收标准                                       │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
│  5. 更新阶段状态追踪                                       │
│     - 在 AGENTS.md 中更新阶段状态                          │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  6. 进入下一阶段                                             │
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  6. 进入下一阶段                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 目录结构规范

```
iflow-go/
├── cmd/                        # CLI 命令定义
│   ├── root.go
│   ├── serve.go
│   ├── token.go
│   └── version.go
│
├── internal/                   # 内部包 (不对外暴露)
│   ├── proxy/                  # API 代理逻辑
│   ├── account/                # 账号管理
│   ├── oauth/                  # OAuth 认证
│   ├── server/                 # HTTP 服务器
│   └── config/                 # 配置管理
│
├── pkg/                        # 可导出包 (可选)
│   └── types/                  # 公共类型定义
│
├── data/                       # 运行时数据 (git ignored)
│   └── accounts/               # 账号存储
│
├── docs/                       # 文档
│   ├── research/               # 调研文档
│   ├── archive/                # 已完成计划归档
│   ├── architecture.md         # 项目架构
│   └── plan.md                 # 实施计划
│
├── AGENTS.md                   # 本文件
├── main.go                     # 程序入口
├── go.mod
├── go.sum
├── Makefile
├── .env.example
├── .gitignore
└── README.md
```

---

## 4. 代码规范

### 4.1 包命名
- 使用小写单词，无下划线
- 名字应简洁、有意义
- 例: `proxy`, `account`, `oauth`, `server`

### 4.2 文件命名
- 使用小写单词，下划线分隔
- 文件名应反映内容
- 例: `signature.go`, `header_builder.go`

### 4.3 函数/方法命名
- 导出函数: 大写开头，驼峰命名
- 内部函数: 小写开头，驼峰命名
- 接口方法: 动词或动词短语

### 4.4 错误处理
- 所有错误必须处理，禁止忽略
- 使用 `fmt.Errorf` 包装错误上下文
- 自定义错误类型放在对应包的 `errors.go` 中

### 4.5 日志规范
- 使用 `github.com/rs/zerolog`
- 日志级别: debug < info < warn < error
- 结构化日志，使用字段而非字符串拼接

```go
log.Info().
    Str("uuid", uuid).
    Str("model", model).
    Msg("Request received")
```

---

## 5. 测试规范

### 5.1 测试文件
- 与被测文件同目录
- 命名: `{filename}_test.go`

### 5.2 测试函数
- 功能测试: `Test{FunctionName}`
- 基准测试: `Benchmark{FunctionName}`
- 示例测试: `Example{FunctionName}`

### 5.3 测试覆盖率
- 目标: > 70%
- 检查: `go test -cover ./...`

---

## 6. Git 提交规范

### 6.1 提交消息格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

### 6.2 提交类型
- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档更新
- `style`: 代码格式
- `refactor`: 重构
- `test`: 测试
- `chore`: 构建/工具

### 6.3 示例
```
feat(proxy): implement HMAC signature generation

- Add GenerateSignature function
- Support SHA256 algorithm
- Match Python implementation

Closes #P4-1
```

---

## 7. 依赖管理

### 7.1 添加依赖
```bash
go get <package>@<version>
```

### 7.2 更新依赖
```bash
go get -u <package>
go mod tidy
```

### 7.3 验证依赖
```bash
go mod verify
```

---

## 8. 环境变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `IFLOW_HOST` | `0.0.0.0` | 监听地址 |
| `IFLOW_PORT` | `28000` | 监听端口 |
| `IFLOW_CONCURRENCY` | `1` | 并发数 |
| `IFLOW_DATA_DIR` | `./data` | 数据目录 |
| `IFLOW_LOG_LEVEL` | `info` | 日志级别 |
| `IFLOW_UPSTREAM_PROXY` | (空) | 上游代理 |
| `IFLOW_PRESERVE_REASONING_CONTENT` | `true` | 是否保留 `reasoning_content` 字段 |

---

## 9. 文档更新记录

当 `docs/architecture.md` 发生变更时，必须在此记录：

| 日期 | 变更内容 | 影响范围 |
|------|----------|----------|
| 2026-02-28 | 同步 OAuth 目录结构说明，`client.go` 承担 Token 交换与登录流程 | `docs/architecture.md` |
| 2026-02-28 | 补充根目录 `main.go` 程序入口，统一 CLI 启动路径 | `docs/architecture.md` |
| 2026-02-28 | 新增 `IFLOW_PRESERVE_REASONING_CONTENT`，支持按配置保留 `reasoning_content` 字段 | `docs/architecture.md` |

---

## 10. 阶段状态追踪

当前状态: **全部阶段已完成**

| 阶段 | 状态 | 开始日期 | 完成日期 |
|------|------|----------|----------|
| Phase 0: 项目初始化 | ✅ 已完成 | 2026-02-27 | 2026-02-27 |
| Phase 1: 核心基础设施 | ✅ 已完成 | 2026-02-27 | 2026-02-27 |
| Phase 2: 账号管理 | ✅ 已完成 | 2026-02-27 | 2026-02-27 |
| Phase 3: OAuth 认证 | ✅ 已完成 | 2026-02-28 | 2026-02-28 |
| Phase 4: API 代理 | ✅ 已完成 | 2026-02-28 | 2026-02-28 |
| Phase 5: HTTP 服务器 | ✅ 已完成 | 2026-02-28 | 2026-02-28 |
| Phase 6: CLI 完善 | ✅ 已完成 | 2026-02-28 | 2026-02-28 |
| Phase 7: 测试与文档 | ✅ 已完成 | 2026-02-28 | 2026-02-28 |

状态说明:
- ⏳ 待开始
- 🔄 进行中
- ✅ 已完成
- ❌ 已阻塞

---

## 11. 归档目录结构

```
docs/archive/
└── plan-completed-{YYYYMMDD}.md
```

归档时机：所有阶段完成后

每个归档文件应包含:
1. 完成日期
2. 所有阶段的任务清单完成状态
3. 遇到的问题和解决方案
4. 验收结果
5. 备注

每个归档文件应包含:
1. 完成日期
2. 任务清单 (全部标记 [x])
3. 遇到的问题和解决方案
4. 验收结果
5. 备注

---

## 12. 联系与支持

如有问题或需要澄清，请参考:
- 调研文档: `docs/research/`
- Python 源码: `iflow2api/`
- Go 库文档: `docs/research/04-go-libraries.md`
